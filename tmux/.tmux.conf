# stolen from https://github.com/sspaeti/dotfiles/blob/master/tmux/.tmux.conf

unbind r
bind r source-file ~/.tmux/tmux.conf

set-option -g default-shell /usr/bin/fish
set -g default-terminal "tmux-256color"

# Important timing settings
set -sg escape-time 0
set -g focus-events on

# Ensure proper key forwarding
# set-option -g xterm-keys on

# when closing a session, go to the next one
set-option -g detach-on-destroy off
# and close current session (above will automatically switch to next session)
bind q kill-session
# bind T display-popup -E "tt"

#start windows and panes at 1, not 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Alt+1: select window 1 if it exists, otherwise create it
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-2 if-shell "tmux list-windows | grep -q '^2:'" "select-window -t 2" "new-window -t 2"
bind -n M-3 if-shell "tmux list-windows | grep -q '^3:'" "select-window -t 3" "new-window -t 3"
bind -n M-4 if-shell "tmux list-windows | grep -q '^4:'" "select-window -t 4" "new-window -t 4"


# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'christoomey/vim-tmux-navigator' # for navigating panes and vim/nvim with Ctrl-hjkl
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-resurrect' # persist tmux sessions after computer restart
set -g @plugin 'tmux-plugins/tmux-continuum' # automatically saves sessions for you every 15 minutes. Knwon issue: In order to be executed periodically, the plugin updates the status-right tmux variable. In case some plugin (usually themes) overwrites the status-right variable, the autosave feature stops working. To fix this issue, place the plugin last in the TPM plugins list.


# Preserves what was readable in each pane.
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
# save every 60min
set -g @continuum-save-interval '60'
set -g @continuum-restore 'on'

# Change default prefix key
unbind C-b
set-option -g prefix C-a
set-option -g repeat-time 0

set-window-option -g mode-keys vi
# entering vim mode to copy or scroll up with vim motions
bind 'v' copy-mode

bind-key -T copy-mode-vi 'v' send -X begin-selection # start selecting text with "v"
bind-key -T copy-mode-vi 'y' send -X copy-selection # copy text with "y"
unbind -T copy-mode-vi MouseDragEnd1Pane # don't exit copy mode after dragging with mouse

# Bindkey "<Prefix> \" to edit buffer in a new nvim session
bind-key -N "Edit buffer in a new nvim session" \\ {
  capture-pane -S -
  save-buffer /tmp/tmux_buffer_tmp
  delete-buffer
  split-window
  send-keys 'nvim /tmp/tmux_buffer_tmp' Enter
}

# map another shortcut to clear window as c-l is now taken for navigation: now `ctrl+t and b`
bind b send-keys 'C-l'
# set switching between last active tabs forth and back
bind-key k select-window -l
# different key bindings for splitting and opening in current path
bind l split-window -h -c "#{pane_current_path}"
# unbind
bind j split-window -v -c "#{pane_current_path}"

# Switching tmux zoom between panes without zooming out
bind -r u select-pane -t .+1 \;  resize-pane -Z

# set `prefix + ctrl + z` (not `prefix + z`) to zoom to avoid accidental suspend my tmux session, what prefix + ctrl + z does by default.
bind C-z resize-pane -Z

# double keymaps as in vim are not possible -> sticking with <c-hjkl> thenjkl> thenjkl> then
# unbind s
bind S choose-session
# fzf behaviour: bind search to fzf

# easily switch session with ctrl+s
bind-key -n C-s run-shell -b "~/.tmux/tmux-switch-session.sh"
# unbind due to conflict with changing sessions
unbind C-s

# switch/jump between two recent sessions
bind-key ";" switch-client -l

# Enable mouse mode (tmux 2.1 and above) such as select window
set -g mouse on

# enable pass through for folke/zen-mode.nvim to hide tmux status
set-option -g allow-passthrough on

#source status line theme for tmux:
source-file ~/.tmux/themes/tmux-kanagawa-dark.conf

# able to refresh tmux config with "Ctrl-t" and then "r":
#unbind r
bind r source-file ~/.tmux.conf

set -g status-right '\
#[bg=colour237,fg=colour239 nobold, nounderscore, noitalics]\
#[bg=colour239,fg=colour246] CPU #{cpu_percentage}  RAM #{ram_percentage} \
#[bg=colour239,fg=colour248,nobold,noitalics,nounderscore]\
#[bg=colour248,fg=colour237]'
# set -g status-right ' '
#set -g status-right "CPU: #{cpu_percentage} | %H:%M"
#set -g status-right "  | #{ram_icon} #{ram_percentage}"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
